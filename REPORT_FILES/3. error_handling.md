# Error Handling Documentation - Bank Saving System

## üéØ Overview

Bank Saving System mengimplementasikan error handling komprehensif di semua layer (frontend, backend, database) untuk memastikan user experience yang baik dan data integrity.

---

## üìã Validation Rules

### Customer Validation

| Field | Rule | Error Message |
|-------|------|---------------|
| `name` | Required | "Name is required" |
| `name` | Min length: 3 | "Name must be at least 3 characters long" |
| `name` | Type: String | "Name must be a string" |

**Example Valid:**
```json
{
  "name": "John Doe"
}
```

**Example Invalid:**
```json
{
  "name": "Jo"  // ‚ùå Too short (< 3 chars)
}
```

---

### Deposito Type Validation

| Field | Rule | Error Message |
|-------|------|---------------|
| `name` | Required | "Name is required" |
| `name` | Not empty | "Name cannot be empty" |
| `yearly_return` | Required | "Yearly return is required" |
| `yearly_return` | Type: Float | "Yearly return must be a number" |
| `yearly_return` | Range: 0-1 | "Yearly return must be between 0 and 1 (e.g., 0.05 for 5%)" |

**Example Valid:**
```json
{
  "name": "Gold Deposito",
  "yearly_return": 0.05
}
```

**Example Invalid:**
```json
{
  "yearly_return": 1.5  // ‚ùå > 1 (150% tidak valid)
}
```

---

### Account Validation

| Field | Rule | Error Message |
|-------|------|---------------|
| `customer_id` | Required | "Valid customer ID is required" |
| `customer_id` | Type: UUID | "Customer ID must be a valid UUID" |
| `customer_id` | Must exist | "Customer not found" |
| `deposito_type_id` | Required | "Valid deposito type ID is required" |
| `deposito_type_id` | Type: UUID | "Deposito type ID must be a valid UUID" |
| `deposito_type_id` | Must exist | "Deposito type not found" |
| `initial_balance` | Optional | - |
| `initial_balance` | Min: 0 | "Initial balance must be a positive number" |

**Example Valid:**
```json
{
  "customer_id": "9171310b-c6cf-4261-b40d-fa7f84b33dd6",
  "deposito_type_id": "8c8e3a40-9b8d-4d7b-9c8a-1234567890ab",
  "initial_balance": 1000000
}
```

**Example Invalid:**
```json
{
  "customer_id": "invalid-uuid",  // ‚ùå Not a valid UUID
  "deposito_type_id": "8c8e3a40-9b8d-4d7b-9c8a-1234567890ab"
}
```

---

### Transaction Validation

#### Deposit Validation
| Field | Rule | Error Message |
|-------|------|---------------|
| `account_id` | Required | "Valid account ID is required" |
| `account_id` | Type: UUID | "Account ID must be a valid UUID" |
| `account_id` | Must exist | "Account not found" |
| `amount` | Required | "Amount is required" |
| `amount` | Type: Float | "Amount must be a number" |
| `amount` | Min: 0.01 | "Amount must be greater than 0" |
| `transaction_date` | Required | "Valid transaction date is required" |
| `transaction_date` | Format: ISO 8601 | "Transaction date must be in ISO 8601 format" |

#### Withdrawal Validation
Same as deposit, plus:

| Field | Rule | Error Message |
|-------|------|---------------|
| `account.balance` | Must be sufficient | "Insufficient balance" |
| `amount` | Must be <= balance + interest | "Amount exceeds available balance plus interest" |

**Example Valid:**
```json
{
  "account_id": "7a3e9140-5c22-4c9b-9f85-abcdef123456",
  "amount": 500000,
  "transaction_date": "2025-12-03T10:00:00Z"
}
```

**Example Invalid:**
```json
{
  "amount": -100  // ‚ùå Negative amount
}
```

---

## üö¶ HTTP Status Codes

### Success Codes
| Code | Meaning | Usage |
|------|---------|-------|
| 200 OK | Success | GET, PUT, DELETE requests |
| 201 Created | Resource created | POST requests |

### Client Error Codes
| Code | Meaning | Usage |
|------|---------|-------|
| 400 Bad Request | Validation error | Invalid input data |
| 404 Not Found | Resource not found | ID doesn't exist |

### Server Error Codes
| Code | Meaning | Usage |
|------|---------|-------|
| 500 Internal Server Error | Server error | Unexpected errors |

---

## üì§ Error Response Format

### Standard Error Response
```json
{
  "success": false,
  "error": "Error message here"
}
```

### Validation Error Response (400)
```json
{
  "success": false,
  "error": "Name must be at least 3 characters long"
}
```

### Not Found Error Response (404)
```json
{
  "success": false,
  "error": "Customer not found"
}
```

### Multiple Validation Errors
```json
{
  "success": false,
  "errors": [
    {
      "field": "name",
      "message": "Name is required"
    },
    {
      "field": "yearly_return",
      "message": "Yearly return must be between 0 and 1"
    }
  ]
}
```

---

## üé® Frontend Error Handling

### Redux Saga Error Pattern
```typescript
try {
  const response = yield call(api.fetchCustomers);
  yield put(fetchCustomersSuccess(response.data));
} catch (error: any) {
  yield put(fetchCustomersFailure(error.message));
}
```

### Error Display
- **Toast Messages** - For transient errors (network, validation)
- **Inline Errors** - For form field errors
- **Error State** - For failed data loads

### Error States in Redux
```typescript
interface CustomerState {
  customers: Customer[];
  loading: boolean;
  error: string | null;  // Error message
}
```

---

## üîß Backend Error Handling

### Global Error Handler
```typescript
// src/middleware/errorHandler.ts
export const errorHandler = (err, req, res, next) => {
  if (err instanceof AppError) {
    return res.status(err.statusCode).json({
      success: false,
      error: err.message
    });
  }
  
  // Unknown errors
  return res.status(500).json({
    success: false,
    error: 'Internal server error'
  });
};
```

### Custom AppError Class
```typescript
class AppError extends Error {
  statusCode: number;
  
  constructor(message: string, statusCode: number) {
    super(message);
    this.statusCode = statusCode;
  }
}
```

### Validation Middleware
```typescript
// src/middleware/validator.ts
export const validateRequest = (req, res, next) => {
  const errors = validationResult(req);
  if (!errors.isEmpty()) {
    return res.status(400).json({
      success: false,
      errors: errors.array()
    });
  }
  next();
};
```

---

## ‚ö†Ô∏è Edge Cases & Handling

### 1. Duplicate Customer Account
**Scenario:** Customer tries to create second account

**Validation:**
```typescript
// Check if customer already has an account
const existingAccount = await getAccountByCustomerId(customer_id);
if (existingAccount) {
  throw new AppError('Customer already has an account', 400);
}
```

**Error Response:**
```json
{
  "success": false,
  "error": "Customer already has an account"
}
```

---

### 2. Insufficient Balance for Withdrawal
**Scenario:** User tries to withdraw more than available

**Validation:**
```typescript
const totalAvailable = account.balance + calculatedInterest;
if (amount > totalAvailable) {
  throw new AppError('Insufficient balance', 400);
}
```

**Error Response:**
```json
{
  "success": false,
  "error": "Insufficient balance"
}
```

---

### 3. Delete Customer with Active Account
**Scenario:** Try to delete customer who has an account

**Validation:**
```typescript
const accounts = await getAccountsByCustomerId(customerId);
if (accounts.length > 0) {
  throw new AppError('Cannot delete customer with active accounts', 400);
}
```

---

### 4. Invalid Date Format
**Scenario:** Transaction date is not ISO 8601

**Validation:**
```typescript
body('transaction_date')
  .isISO8601()
  .withMessage('Valid transaction date is required')
```

**Error Response:**
```json
{
  "success": false,
  "error": "Valid transaction date is required"
}
```

---

### 5. Network Error (Frontend)
**Scenario:** No internet connection or API is down

**Handling:**
```typescript
// src/services/api.ts
apiClient.interceptors.response.use(
  (response) => response.data,
  (error) => {
    if (error.request && !error.response) {
      return Promise.reject(new Error('Network error. Please check your connection.'));
    }
    return Promise.reject(error);
  }
);
```

**Display:**
- Toast: "Network error. Please check your connection."

---

### 6. Foreign Key Violation
**Scenario:** Try to delete deposito type used by accounts

**Supabase Error:**
```
violates foreign key constraint
```

**Handled As:**
```json
{
  "success": false,
  "error": "Cannot delete deposito type that is being used by accounts"
}
```

---

## üìä Common Error Scenarios

### Scenario Matrix

| User Action | Error Condition | HTTP Code | Error Message | Solution |
|-------------|----------------|-----------|---------------|----------|
| Create Customer | Name too short | 400 | "Name must be at least 3 characters long" | Enter name with 3+ chars |
| Create Deposito Type | Yearly return = 1.5 | 400 | "Yearly return must be between 0 and 1" | Enter 0-1 (e.g., 0.05) |
| Create Account | Customer not found | 404 | "Customer not found" | Select valid customer |
| Create Account | Customer has account | 400 | "Customer already has an account" | Select different customer |
| Process Withdrawal | Insufficient balance | 400 | "Insufficient balance" | Enter smaller amount |
| Get Customer | Invalid UUID | 400 | "Invalid UUID format" | Use valid UUID |
| Delete Customer | Has active accounts | 400 | "Cannot delete customer with active accounts" | Delete accounts first |
| API Call | Network error | - | "Network error. Please check your connection." | Check internet |

---

## ‚úÖ Best Practices

### Frontend
1. ‚úÖ Always wrap API calls in try-catch
2. ‚úÖ Display user-friendly error messages
3. ‚úÖ Show loading states during API calls
4. ‚úÖ Provide retry mechanism for network errors
5. ‚úÖ Validate input before API call (client-side)

### Backend
1. ‚úÖ Use express-validator for input validation
2. ‚úÖ Return consistent error format
3. ‚úÖ Use appropriate HTTP status codes
4. ‚úÖ Log errors for debugging
5. ‚úÖ Don't expose sensitive error details to client

### Database
1. ‚úÖ Use foreign key constraints
2. ‚úÖ Use UUID for primary keys (prevent enumeration)
3. ‚úÖ Handle constraint violations gracefully
4. ‚úÖ Use database transactions for critical operations

---

## üéØ Error Handling Checklist

- [x] All endpoints have input validation
- [x] Global error handler implemented
- [x] Consistent error response format
- [x] User-friendly error messages
- [x] Frontend displays errors appropriately
- [x] Network errors handled
- [x] Database constraints enforced
- [x] Edge cases covered
- [x] Error logging implemented
- [x] HTTP status codes used correctly
